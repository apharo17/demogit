<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8"/>
		<title>Tegola Demo Viewer</title>

		<script type="application/json" id="options">
		    {
		    	"start":{
	    			"zoom":15,
	    			"longitude":-117.15117725013909,
	    			"latitude":32.72269876352742,
	    			"bearing":0,
	    			"pitch":0,
		    		"style":"hot-osm",
		    		"map":"ec2",
		    		"lib":"mapbox"
		    	},
		        "styles":[{
		        	"key":"hot-osm",
		        	"label":"HOT OSM",
		        	"tileSrc":"images/hot-osm.png",
		        	"mapboxStyle":"styles/hot-osm3d.json",
		        	"olStyle":"styles/hot-osm.json"
		        },{
		        	"key":"camo",
		        	"label":"Camo",
		        	"tileSrc":"images/camo.png",
		        	"mapboxStyle":"styles/camo3d.json",
		        	"olStyle":"styles/camo.json"
		        },{
		        	"key":"night-vision",
		        	"label":"Night",
		        	"tileSrc":"images/night-vision.png",
		        	"mapboxStyle":"styles/night-vision3d.json",
		        	"olStyle":"styles/night-vision.json"
		        },{
		        	"key":"mobility",
		        	"label":"Mobility",
		        	"tileSrc":"images/mobility.png",
		        	"mapboxStyle":"styles/mobility3d.json",
		        	"olStyle":"styles/mobility.json"
		        },{
		        	"key":"osgeo",
		        	"label":"OSGeo",
		        	"tileSrc":"images/osgeo.png",
		        	"mapboxStyle":"styles/osgeo3d.json",
		        	"olStyle":"styles/osgeo.json"
		        }],
		        "maps":[{
		        	"key":"ec2",
		        	"label":"EC2",
		        	"sources":{
	        			"osm":{
	        				"url":"https://osm.tegola.io/capabilities/osm.json",
	        				"type":"vector"
	        			},
	        			"satellite":{
	        				"url":"http://osm.tegola.io/{z}/{x}/{y}",
	        				"type":"raster",
	        				"attribution":"Â© DigitalGlobe, Inc"
	        			}
	        		},
		        	"url":"https://osm.tegola.io/capabilities/osm.json",
		        	"styleName":"osm"
		        }],
		        "libs":[{
		        	"key":"mapbox",
		        	"label":"Mapbox",
		        	"library":"mapbox",
		        	"accessToken":"pk.eyJ1IjoiamowaG5zMG4iLCJhIjoiY2o1YjRtMjZpMGd2MDJ3bW00bnA5NXdyMiJ9.qlR4a_qfTlKZs1Qisk6sAg"
		        },{
		        	"key":"ol",
		        	"label":"Open Layers",
		        	"library":"ol"
		        }]
		    }
		</script>
		<style type="text/css">
			*{margin:0;padding:0;box-sizing:border-box;vertical-align:middle;}

			@font-face {
			  font-family:'Open Sans';
			  font-style:normal;
			  font-weight:400;
			  src:local('Open Sans Regular'),local('OpenSans-Regular'),url(fonts/open-sans-regular.woff2) format('woff2');
			}

			#olMap{width:100%;height:100%;position:relative;z-index:2;}
			#mapboxMap{width:100%;height:100%;position:relative;z-index:1;}
			#stylebar{position:fixed;bottom:0;left:0;color:#333;margin:16px;
				-webkit-box-shadow:3px 7px 8px -10px rgba(0,0,0,0.6);
				-moz-box-shadow:3px 7px 8px -10px rgba(0,0,0,0.6);
				box-shadow:3px 7px 8px -10px rgba(0,0,0,0.6);
				z-index:3;
			}
			#optionsbar{position:fixed;bottom:0;right:0;color:#333;margin:16px;
				-webkit-box-shadow:3px 7px 8px -10px rgba(0,0,0,0.6);
				-moz-box-shadow:3px 7px 8px -10px rgba(0,0,0,0.6);
				box-shadow:3px 7px 8px -10px rgba(0,0,0,0.6);
				z-index:3;
			}

			.tool{font-family:'Open Sans',sans-serif;float:left;background-color:rgba(255,255,255,1);
				border:1px solid #E9EDEF;position:relative;font-size:16px;
				cursor:pointer;border-left:none;}
			.tool:first-child{border-left:1px solid #E9EDEF;border-top-left-radius:4px;border-bottom-left-radius:4px;}
			.tool:last-child{border-top-right-radius:4px;border-bottom-right-radius:4px;}
			.tool:hover{background-color:#D9EAFB;border-color:#BBCEE3;}
			.tool.active{background-color:#548DC3;border-color:#6899D5;color:#fff;}
			
			.tool .tile{width:38px;height:38px;line-height:36px;border-radius:2px;
				position:relative;margin:3px;display:inline-block;
				border:1px solid rgba(255,255,255,0.3);opacity:0.85;}
			.tool:hover .tile{opacity:1;}
			.tool.active .tile{opacity:1;}
			.tool .label{line-height:40px;height:40px;
				margin:2px 14px 2px 12px;display:inline-block;}
			.tool .label i{position:relative;top:0;margin-right:3px;}
			
			.drop-up{position:absolute;bottom:48px;right:-1px;
				list-style-type:none;margin:0;padding:0;}
			.drop-up li{display:block;position:relative;margin:0;padding:0;border-top:1px solid #E9EDEF;
				border-left:1px solid #E9EDEF;border-right:1px solid #E9EDEF;background-color:#fff;
				min-width:160px;overflow:hidden;}
			.drop-up li:first-child{border-top-left-radius:4px;border-top-right-radius:4px;}
			.drop-up li:last-child{border-bottom:1px solid #E9EDEF;
				border-bottom-left-radius:4px;border-bottom-right-radius:0;}
			.drop-up li:hover{background-color:#D9EAFB;border-color:#BBCEE3;}
			.drop-up li.active{background-color:#548DC3;border-color:#6899D5;color:#fff;}
			.drop-up li .tile{position:absolute;margin:2px;}
			.drop-up li .label{line-height:44px;margin:2px 14px 2px 12px;}

			.display-none{display:none;}

			@media only screen and (max-width:1000px) {
				#stylebar .label{display:none;}
			}
		</style>

		<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no"/>
		<link rel="stylesheet" type="text/css" href="libs/openlayers/4.4.2/ol.css">
		<link rel="stylesheet" type="text/css" href="libs/mapbox-gl-js/v0.41.0/mapbox-gl.css"/>
		<link rel="stylesheet" type="text/css" href="libs/font-awesome/4.7.0/css/font-awesome.min.css">
	</head>
	<body>
		<div id="mapContainer">
			<div id="mapboxMap" class="display-none"></div>
			<div id="olMap" class="display-none"></div>
			<div id="stylebar" class="display-none"></div>
			<div id="optionsbar">
			</div>
			<div id="liboption" class="tool display-none" onclick="clickToggle('libbar');">
				<div class="label">
					<i class="fa fa-cubes" aria-hidden="true"></i> 
					<span id="libLabel"></span>
				</div>
				<ul id="libbar" class="drop-up display-none">
				</ul>
			</div>
			<div id="mapoption" class="tool display-none" onclick="clickToggle('mapbar');">
				<div class="label">
					<i class="fa fa-server" aria-hidden="true"></i> 
					<span id="mapLabel"></span>
				</div>
				<ul id="mapbar" class="drop-up display-none">
				</ul>
			</div>
		</div>
	</body>
    <script src="libs/openlayers/4.4.2/ol.js"></script>
	<script src="libs/ol-mapbox-style/olms.js"></script>
	<script src="libs/mapbox-gl-js/v0.41.0/mapbox-gl.js"></script>
	<script type="text/javascript">
		'use strict';

		(()=>{
			try{
				var options = JSON.parse(document.getElementById('options').innerHTML);
			}catch(e){
				return console.error('error parsing options JSON:',e);
			}
			console.log('options:',options);

			//check for required options
			if (!options.start) return console.error('options: no start defined');
			if (!options.styles) return console.error('options: no styles defined');
			if (!options.maps) return console.error('options: no maps defined');
			if (!options.libs) return console.error('options: no libs defined');

			var styles = {}, maps = {}, libs = {},
				currentState = {};

			// getState pulls the app state from the query first, then the start configs
			var getState = function(){
				var query = parseQuery();

				/*
				// query mapping old => new

				theme -> style
				source -> map
				renderer -> lib
				*/


				query.zoom = +query.zoom || options.start.zoom;
				query.latitude = +query.latitude || options.start.latitude;
				query.longitude = +query.longitude || options.start.longitude;
				query.bearing = +query.bearing || options.start.bearing;
				query.pitch = +query.pitch || options.start.pitch;
				query.style = query.style || options.start.style;
				query.map = query.map || options.start.map;
				query.lib = query.lib || options.start.lib;
				return query;
			};
			var setState = function(state){
				var query = makeQuery(state);
				window.history.pushState(undefined,'posUpdate',query);
			};
			var parseQuery = function(){
				var url = window.location.href,
					query = {},
					qInd = url.indexOf('?');
				if (qInd === -1) return query;
				var props = url.slice(qInd+1).split('&');
			    for(var i=0,len=props.length;i<len;i++){
			        var prop = props[i].split('=');
			        query[prop[0]] = decodeURIComponent(prop[1]);
			    }
			    return query;
			};
			var makeQuery = function(state){
				var parts = [];
				for (var i in state){
					parts.push(i+'='+encodeURIComponent(state[i]));
				}
				if (parts.length < 1) return '';
			    return '?'+parts.join('&');
			};
			var elFromStr = function(str){
				var div = document.createElement('div');
				div.innerHTML = str;
				return div.firstChild;
			};
			var getType = function(d){
				if (d === undefined) return 'und';
				if (d === null) return 'null';
				if (d === true || d === false) return 'bool';
				var t = typeof d;
				if (t == 'string') return 'str';
				if (t == 'number') return 'num';
				if (t == 'function') return 'fun';
				if (Object.prototype.toString.call(d) == '[object Array]') return 'ary';
				return 'obj';
			};
			var clone = function(obj){
				if (arguments.length == 0) obj = this;
				if (getType(obj) !== 'obj') return console.error('clone: argument must be type object');
				var obj2 = {};
				for (var i in obj){
					if (getType(obj[i]) == 'obj'){
						obj2[i] = clone(obj[i]);
						continue;
					}
					if (getType(obj[i]) == 'ary'){
						obj2[i] = [];
						obj[i].forEach((val)=>{
							obj2[i].push(val);
						});
						continue;
					}
					obj2[i] = obj[i];
				}
				return obj2;
			};
			var setTheme = function(key){
				var style = styles[key];
				if (!style) return console.error('style:',key,' not found');
				for (var i in styles){
					styles[i].el.className = styles[i].el.className.replace(' active','');
				}
				style.el.className = style.el.className+' active';
				currentState.style = key;
			};
			var setMap = function(key){
				var map = maps[key];
				if (!map) return console.error('map:',key,' not found');
				for (var i in maps){
					maps[i].el.className = maps[i].el.className.replace(' active','');
				}
				map.el.className = map.el.className+' active';
				document.getElementById('mapLabel').innerHTML = map.label;
				currentState.map = key;
			};
			var setRenderer = function(key){
				var lib = libs[key];
				if (!lib) return console.error('lib:',key,' not found');
				for (var i in libs){
					libs[i].el.className = libs[i].el.className.replace(' active','');
				}
				lib.el.className = lib.el.className+' active';
				document.getElementById('libLabel').innerHTML = lib.label;
				if (currentState.lib && currentState.lib != key){
					libs[currentState.lib].client.clear();
				}
				currentState.lib = key;
			};
			var updateMap = function(){
				if (!currentState.lib) return console.error('no lib defined');
				var lib = libs[currentState.lib];
				lib.client.render();
			};
			var loadJsonFile = function(url,loaded){
				var xhr = new XMLHttpRequest();
				xhr.open('GET', url);
				var a = document.createElement('A');
				a.href = url;
				xhr.addEventListener('load',()=>{
					try{
						//console.log('response:',xhr.responseText);
						var json = JSON.parse(xhr.responseText);
					} catch(e){
						return console.error('error parsing json from file:',url,e);
					}
					loaded(json);
				});
				xhr.addEventListener('error', function () {
					console.error('error loading file:',url);
				});
				xhr.send();
			};

			window.clickSetTheme = function(key){
				setTheme(key);
				setState(currentState);
				updateMap();
			};
			window.clickSetSource = function(key){
				setMap(key);
				setState(currentState);
				updateMap();
			};
			window.clickSetRenderer = function(key){
				setRenderer(key);
				setState(currentState);
				updateMap();
			};
			window.clickToggle = function(id){
				var toggle = document.getElementById(id);
				if (toggle.style.display == 'block'){
					toggle.style.display = 'none';
				} else {
					toggle.style.display = 'block';
				}
			};

			options.styles.forEach((config,ind)=>{
				var style = clone(config);

				var html = '<div class="tool" onclick="clickSetTheme(\''+style.key+'\');">';
				html += '<div class="tile" style="background:url('+style.tileSrc+');"></div>';
				html += '<div class="label">'+style.label+'</div>';
				html += '</div>';

				style.el = elFromStr(html);
				document.getElementById('stylebar').appendChild(style.el);
				styles[style.key] = style;
			});
			if (options.styles.length > 1) document.getElementById('stylebar').style.display = 'block';

			options.maps.forEach((config,ind)=>{
				var map = clone(config);

				var html = '<li onclick="clickSetSource(\''+map.key+'\');">';
				html += '<div class="label">'+map.label+'</div>';
				html += '</li>';

				map.el = elFromStr(html);
				document.getElementById('mapbar').appendChild(map.el);
				maps[map.key] = map;
			});
			if (options.maps.length > 1){
				var mapOption = document.getElementById('mapoption');
				mapOption.style.display = 'block';
				document.getElementById('optionsbar').appendChild(mapOption);
			}

			options.libs.forEach((config,ind)=>{
				var lib = clone(config);

				var html = '<li onclick="clickSetRenderer(\''+lib.key+'\');">';
				html += '<div class="label"> '+lib.label+'</div>';
				html += '</li>';

				lib.el = elFromStr(html);
				document.getElementById('libbar').appendChild(lib.el);
				libs[lib.key] = lib;
			});
			if (options.libs.length > 1){
				var libOption = document.getElementById('liboption');
				libOption.style.display = 'block';
				document.getElementById('optionsbar').appendChild(libOption);
			}

			var mapboxClient = {
				render:function(){
					document.getElementById('mapboxMap').style.display = 'block';

					var style = styles[currentState.style];
					var lib = libs[currentState.lib];
					var map = maps[currentState.map];
					var center = [currentState.longitude,currentState.latitude];

					if (lib.accessToken) mapboxgl.accessToken = lib.accessToken;

					loadJsonFile(style.mapboxStyle,(styleJson)=>{
						var styleSources = {};
						for (var i in styleJson.sources){
							if (map.sources[i]){ // source is defined in map
								styleSources[i] = clone(styleJson.sources[i]);
								for (var j in map.sources[i]){ // overwrite style sources with map source settings
									styleSources[i][j] = map.sources[i][j];
								}
							}
						}
						styleJson.sources = styleSources;

						//console.log('center:',center,style);

						if (!this.el){
		  					this.el = new mapboxgl.Map({
								container:'mapboxMap',
								style:styleJson,
								center:center,
								bearing:currentState.bearing,
								pitch:currentState.pitch,
								zoom:currentState.zoom
							});
							this.el.on('render',()=>{
								var center = this.el.getCenter();
								currentState.longitude = center.lng;
								currentState.latitude = center.lat;
								currentState.zoom = this.el.getZoom();
								currentState.pitch = this.el.getPitch();
								currentState.bearing = this.el.getBearing();
								setState(currentState);
							});
							this.el.addControl(new mapboxgl.NavigationControl());
							return;
						}

						var changed = false;
						for (var i in currentState){
							if (currentState[i] !== this[i]){
								changed = true;
								break;
							}
						}
						if (!changed) return;
						for (var i in currentState){
							this[i] = currentState[i];
						}

						this.el.setStyle(styleJson);
						this.el.setCenter(center);
						this.el.setZoom(this.zoom);
						this.el.setBearing(this.bearing);
						this.el.setPitch(this.pitch);
					});	
				},
				clear:function(){
					document.getElementById('mapboxMap').style.display = 'none';
				}
			};
			libs['mapbox'].client = mapboxClient;

			var olClient = {
				render:function(){
					document.getElementById('olMap').style.display = 'block';

					var style = styles[currentState.style];
					var center = ol.proj.fromLonLat([currentState.longitude,currentState.latitude]);
					var map = maps[currentState.map];

					this.el = this.el || new ol.Map({target:'olMap'});
					this.view = this.view || this.el.getView();

					// apply styles
					if (this.style != currentState.style){
						olms.apply(this.el,style.olStyle);
					}

					// if source changed blitz layers and rebuild
					if (this.map != currentState.map){
						this.el.getLayers().getArray().forEach((layer)=>{
							this.el.removeLayer(layer);
						});
						for (var i in map.sources){
							var source = map.sources[i];
							if (source.type == 'vector'){
								var format = new ol.format.GeoJSON();
							}
							var layer = new ol.layer.Vector({
								source:new ol.source.Vector({
									url:source.url,
									format:format
								})
							});
							this.el.addLayer(layer);
						}
					}
					if (currentState.zoom !== this.zoom){
						this.view.setZoom(currentState.zoom+1);
					}
					if (currentState.longitude !== this.longitude || 
						currentState.latitude !== this.latitude){
						this.view.setCenter(center);
					}

					for (var i in currentState){
						this[i] = currentState[i];
					}

					/*

					if (!this.map){
						this.map = new ol.Map({
							layers:[
								new ol.layer.Vector({
									source:new ol.source.Vector({
										url:source.url,
										format: new ol.format.GeoJSON()
									})
								})
							],
							target:'olMap'
						});
						this.view = this.map.getView();

						//console.log('zoom:',currentState.zoom+1,center);
						this.view.setZoom(currentState.zoom+1);
						this.view.setCenter(center);
						olms.apply(this.map,style.olStyle);

						return;		
					}
					var changed = false;
					for (var i in currentState){
						if (currentState[i] !== this[i]){
							changed = true;
							break;
						}
					}
					if (!changed) return;
					//console.log('style:',style);
					this.map.getLayers().getArray().forEach((layer)=>{
						this.map.removeLayer(layer);
					});
					olms.apply(this.map,style.olStyle);

					if (currentState.source !== this.source){
						var layer = new ol.layer.Vector({
							source:new ol.source.Vector({
								url:source.url,
								format:new ol.format.GeoJSON()
							})
						});
						this.map.addLayer(layer);
					}
					if (currentState.zoom !== this.zoom){
						this.view.setZoom(currentState.zoom+1);
					}
					if (currentState.longitude !== this.longitude || 
						currentState.latitude !== this.latitude){
						this.view.setCenter(center);
					}

					

					for (var i in currentState){
						this[i] = currentState[i];
					}*/
				},
				clear:function(){
					document.getElementById('olMap').style.display = 'none';
				}
			};
			libs['ol'].client = olClient;

			currentState = getState();

			document.getElementById('mapboxMap').style.height = window.innerHeight+'px';
			document.getElementById('olMap').style.height = window.innerHeight+'px';

			setTheme(currentState.style);
			setMap(currentState.map);
			setRenderer(currentState.lib);
			updateMap();

		})();

	</script>
	
</html>

